{% extends "base.html" %}

{% block content %}
<!-- API Key prompt (shown when no key is stored) -->
<div id="api-key-prompt" class="card mb-6 border-primary hidden">
    <div class="flex items-start space-x-3">
        <svg class="w-6 h-6 text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
        </svg>
        <div>
            <p class="text-text font-medium">OpenAI API Key Required</p>
            <p class="text-text-muted text-sm mt-1">
                This app uses a "bring your own key" model. Your key is stored securely on the server and never exposed to browser JavaScript.
            </p>
            <button onclick="ApiKeyUI.showModal()" class="mt-2 text-sm text-primary hover:text-primary-hover underline">
                Set your API key
            </button>
        </div>
    </div>
</div>

<div class="card">
    <form id="advice-form"
          hx-post="/api/advice/html"
          hx-target="#response-area"
          hx-swap="innerHTML"
          hx-indicator="#loading-indicator">

        <label for="question" class="block text-text mb-2 font-medium">
            What's on your mind?
        </label>

        <textarea
            id="question"
            name="question"
            class="input-field"
            rows="6"
            maxlength="{{ max_chars }}"
            placeholder="Describe your situation or ask a question about relationships, family, friends, or other interpersonal matters..."
            required
            oninput="updateCharCount()"
        ></textarea>

        <div class="flex justify-between items-center mt-2 mb-4">
            <span id="char-count" class="text-text-dark text-sm">
                0 / {{ max_chars }} characters
            </span>
        </div>

        <button type="submit" class="btn-primary w-full" id="submit-btn">
            Get Advice
        </button>
    </form>
</div>

<!-- Loading indicator -->
<div id="loading-indicator" class="htmx-indicator mt-6">
    <div class="card text-center">
        <div class="flex items-center justify-center space-x-3">
            <svg class="loading-spinner h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-text-muted">Generating thoughtful advice...</span>
        </div>
        <p class="text-text-dark text-sm mt-3">This may take up to 45 seconds</p>
    </div>
</div>

<!-- Response area -->
<div id="response-area" class="mt-6"></div>

{% endblock %}

{% block scripts %}
<script>
    const maxChars = {{ max_chars }};
    const textarea = document.getElementById('question');
    const charCount = document.getElementById('char-count');
    const submitBtn = document.getElementById('submit-btn');
    const apiKeyPrompt = document.getElementById('api-key-prompt');

    function updateCharCount() {
        const count = textarea.value.length;
        charCount.textContent = `${count} / ${maxChars} characters`;

        if (count > maxChars * 0.9) {
            charCount.classList.add('text-primary');
            charCount.classList.remove('text-text-dark');
        } else {
            charCount.classList.remove('text-primary');
            charCount.classList.add('text-text-dark');
        }
    }

    // Show/hide API key prompt based on stored key
    function checkApiKeyPrompt() {
        if (apiKeyPrompt) {
            if (typeof ApiKeyManager !== 'undefined' && ApiKeyManager.hasKey()) {
                apiKeyPrompt.classList.add('hidden');
            } else {
                apiKeyPrompt.classList.remove('hidden');
            }
        }
    }

    // Re-check after the async session status check completes
    document.addEventListener('apiKeyStatusReady', checkApiKeyPrompt);
    // Re-check when the API key modal is hidden (after save/logout)
    const observer = new MutationObserver(checkApiKeyPrompt);
    const apiKeyModal = document.getElementById('api-key-modal');
    if (apiKeyModal) {
        observer.observe(apiKeyModal, { attributes: true, attributeFilter: ['class'] });
    }

    // Intercept form submission if no API key
    document.getElementById('advice-form').addEventListener('htmx:beforeRequest', function(evt) {
        if (typeof ApiKeyManager !== 'undefined' && !ApiKeyManager.hasKey()) {
            evt.preventDefault();
            ApiKeyUI.showModal();
            return;
        }
    });

    // Disable submit button while request is in flight
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.elt.id === 'advice-form') {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Thinking...';
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.elt.id === 'advice-form') {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Get Advice';

            // Save the conversation to history if successful
            if (evt.detail.successful) {
                const question = textarea.value;
                const responseArea = document.getElementById('response-area');
                if (question && responseArea && responseArea.innerHTML) {
                    UIManager.saveConversation(question, responseArea.innerHTML);
                }
            }
        }
    });

    // Handle error responses (HTMX doesn't swap content for non-2xx by default)
    document.body.addEventListener('htmx:responseError', function(evt) {
        if (evt.detail.elt.id === 'advice-form') {
            const responseArea = document.getElementById('response-area');
            responseArea.innerHTML = evt.detail.xhr.responseText;
        }
    });

    // Allow Ctrl+Enter to submit
    textarea.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            document.getElementById('advice-form').requestSubmit();
        }
    });
</script>
{% endblock %}
